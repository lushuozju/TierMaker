# 项目架构与工作流程说明

## 📁 项目文件结构

```
tier-list-simple/
├── src/
│   ├── main.ts                 # 应用入口文件
│   ├── App.vue                 # 根组件（主控制器）
│   ├── types.ts                # TypeScript 类型定义
│   ├── style.css               # 全局样式
│   ├── components/             # Vue 组件目录
│   │   ├── TierList.vue       # Tier 列表展示组件
│   │   ├── TierRow.vue        # Tier 行组件（单个等级行）
│   │   ├── SearchModal.vue    # 搜索模态框组件
│   │   └── ConfigModal.vue    # 配置模态框组件
│   └── utils/                  # 工具函数目录
│       ├── storage.ts          # 本地存储工具（数据持久化）
│       ├── bangumi.ts          # Bangumi API 工具
│       ├── vndb.ts             # VNDB API 工具
│       ├── anidb.ts            # AniDB API 工具
│       └── anidb-titles.ts     # AniDB 本地标题索引工具
├── public/
│   └── anime-titles.dat        # AniDB 动画标题数据文件
├── index.html                  # HTML 入口
├── vite.config.ts              # Vite 构建配置
└── package.json                # 项目依赖配置
```

---

## 🔄 核心工作流程

### 1. 应用启动流程

```
main.ts
  ↓
App.vue (onMounted)
  ↓
storage.ts (loadTierData, loadTierConfigs)
  ↓
localStorage (读取数据)
  ↓
初始化 tiers 和 tierConfigs
```

**文件连接：**
- `main.ts` → 导入 `App.vue`
- `App.vue` → 导入 `storage.ts` → 调用 `loadTierData()` 和 `loadTierConfigs()`
- `storage.ts` → 使用浏览器 `localStorage` API

---

### 2. 搜索流程（用户点击添加按钮）

```
用户点击 TierRow 中的 "+" 按钮
  ↓
TierRow.vue (@add-item 事件)
  ↓
TierList.vue (@add-item 事件)
  ↓
App.vue (handleAddItem)
  ↓
显示 SearchModal.vue
  ↓
用户输入关键词
  ↓
SearchModal.vue (watch keyword, 500ms 防抖)
  ↓
根据 apiSource 选择 API：
  ├─ bangumi → bangumi.ts (searchBangumiAnime)
  ├─ vndb    → vndb.ts (searchVndbVisualNovel)
  └─ anidb   → anidb.ts (searchAnidbAnime)
        ↓
    anidb-titles.ts (本地标题搜索)
        ↓
    anidb.ts (getAnimeByAid 批量获取详情)
  ↓
返回 SearchResult[] (统一格式)
  ↓
SearchModal.vue 显示结果
  ↓
用户选择结果
  ↓
SearchModal.vue (handleSelect)
  ↓
转换为 AnimeItem
  ↓
@select 事件 → App.vue (handleSelectAnime)
  ↓
更新 tiers 数据
  ↓
watch(tiers) → storage.ts (saveTierData)
  ↓
localStorage (自动保存)
```

**文件连接：**
- `TierRow.vue` → 触发 `@add-item` → `TierList.vue` → 触发 `@add-item` → `App.vue`
- `App.vue` → 显示 `SearchModal.vue`
- `SearchModal.vue` → 导入 `bangumi.ts`, `vndb.ts`, `anidb.ts`
- `anidb.ts` → 导入 `anidb-titles.ts` (用于本地搜索)
- `SearchModal.vue` → 导入 `types.ts` (使用 `SearchResult`, `AnimeItem` 等类型)
- `App.vue` → 导入 `storage.ts` (自动保存)

---

### 3. 数据持久化流程

```
用户操作（添加/删除/移动项目）
  ↓
App.vue (修改 tiers 数据)
  ↓
watch(tiers, { deep: true })
  ↓
storage.ts (saveTierData)
  ↓
localStorage.setItem('tier-list-data', JSON.stringify(tiers))
```

**文件连接：**
- `App.vue` → 导入 `storage.ts` → 调用 `saveTierData()` / `loadTierData()`
- `ConfigModal.vue` → 导入 `storage.ts` → 调用 `saveBgmToken()` / `loadBgmToken()`

---

### 4. API 调用流程

#### 4.1 Bangumi API

```
SearchModal.vue
  ↓
bangumi.ts (searchBangumiAnime)
  ↓
getAccessToken() → storage.ts (loadBgmToken)
  ↓
getRequestHeaders() → 添加 Authorization 头
  ↓
fetchWithTimeout() → POST https://api.bgm.tv/v0/search/subjects
  ↓
返回 BgmSearchResult[]
```

**文件连接：**
- `SearchModal.vue` → 导入 `bangumi.ts`
- `bangumi.ts` → 导入 `storage.ts` (获取用户 Token)
- `bangumi.ts` → 导入 `types.ts` (使用 `BgmSearchResult` 类型)

#### 4.2 VNDB API

```
SearchModal.vue
  ↓
vndb.ts (searchVndbVisualNovel)
  ↓
WebSocket 连接 → wss://api.vndb.org/kana
  ↓
发送查询请求 (JSON)
  ↓
接收响应 → 解析结果
  ↓
返回 VndbSearchResult[]
```

**文件连接：**
- `SearchModal.vue` → 导入 `vndb.ts`
- `vndb.ts` → 导入 `types.ts` (使用 `VndbSearchResult` 类型)

#### 4.3 AniDB API

```
SearchModal.vue
  ↓
anidb.ts (searchAnidbAnime)
  ↓
anidb-titles.ts (searchAnimeTitles) → 本地搜索 anime-titles.dat
  ↓
返回匹配的 AID 列表
  ↓
anidb.ts (getAnimeByAid) → 批量获取详情
  ↓
HTTP GET → http://api.anidb.net:9001/httpapi
  ↓
解析 XML 响应
  ↓
提取图片 URL (picture 字段)
  ↓
构建图片 URL → https://cdn.anidb.net/images/main/{filename}
  ↓
返回 AnidbSearchResult[]
```

**文件连接：**
- `SearchModal.vue` → 导入 `anidb.ts`
- `anidb.ts` → 导入 `anidb-titles.ts` (本地标题搜索)
- `anidb.ts` → 读取 `public/anime-titles.dat` (通过 fetch)
- `anidb.ts` → 导入 `types.ts` (使用 `AnidbSearchResult` 类型)

---

### 5. 配置管理流程

```
用户点击"设置"按钮
  ↓
App.vue (showConfig = true)
  ↓
显示 ConfigModal.vue
  ↓
ConfigModal.vue (onMounted)
  ↓
storage.ts (loadBgmToken) → 加载用户 Token
  ↓
用户修改配置
  ↓
ConfigModal.vue (@update 事件)
  ↓
App.vue (handleUpdateConfigs)
  ↓
storage.ts (saveTierConfigs, saveBgmToken)
  ↓
localStorage (保存配置)
```

**文件连接：**
- `App.vue` → 显示 `ConfigModal.vue`
- `ConfigModal.vue` → 导入 `storage.ts` (Token 管理)
- `ConfigModal.vue` → 导入 `types.ts` (使用 `TierConfig` 类型)

---

## 📊 数据类型流转

### 类型定义文件：`types.ts`

```typescript
// 核心数据类型
AnimeItem          // 动画/作品项（用于 Tier 列表）
TierConfig         // Tier 等级配置
TierRow            // Tier 行数据
Tier               // Tier 等级数据

// API 搜索结果类型
BgmSearchResult    // Bangumi 搜索结果 (id: number)
VndbSearchResult   // VNDB 搜索结果 (id: string)
AnidbSearchResult  // AniDB 搜索结果 (id: string, aid: number)

// 联合类型
SearchResult = BgmSearchResult | VndbSearchResult | AnidbSearchResult
ApiSource = 'bangumi' | 'vndb' | 'anidb'
```

### 数据转换流程

```
API 响应 (BgmSearchResult/VndbSearchResult/AnidbSearchResult)
  ↓
SearchModal.vue (统一显示为 SearchResult)
  ↓
用户选择
  ↓
handleSelect() → 转换为 AnimeItem
  ↓
App.vue (handleSelectAnime) → 添加到 tiers
  ↓
TierList.vue → 显示 AnimeItem[]
```

---

## 🔗 文件依赖关系图

```
main.ts
  └─ App.vue
      ├─ types.ts (类型定义)
      ├─ storage.ts (数据持久化)
      ├─ components/TierList.vue
      │   ├─ types.ts
      │   └─ components/TierRow.vue
      │       └─ types.ts
      ├─ components/SearchModal.vue
      │   ├─ types.ts
      │   ├─ utils/bangumi.ts
      │   │   ├─ types.ts
      │   │   └─ storage.ts (Token 管理)
      │   ├─ utils/vndb.ts
      │   │   └─ types.ts
      │   └─ utils/anidb.ts
      │       ├─ types.ts
      │       └─ utils/anidb-titles.ts
      │           └─ public/anime-titles.dat
      └─ components/ConfigModal.vue
          ├─ types.ts
          └─ storage.ts (Token 管理)
```

---

## 🗄️ 本地存储结构

### localStorage 键值对

| 键名 | 数据类型 | 说明 | 管理文件 |
|------|---------|------|---------|
| `tier-list-data` | `Tier[]` | Tier 列表数据 | `storage.ts` |
| `tier-config` | `TierConfig[]` | Tier 等级配置 | `storage.ts` |
| `bgm-access-token` | `string` | 用户自定义 Bangumi Token | `storage.ts` |
| `anidb-api-cache` | `AnidbAnimeData[]` | AniDB API 缓存 | `anidb.ts` |
| `anidb-api-cache-timestamp` | `number` | 缓存时间戳 | `anidb.ts` |

---

## 🎯 关键设计模式

### 1. **统一接口模式**
- 三个不同的 API（Bangumi、VNDB、AniDB）返回不同的数据结构
- 通过 `SearchResult` 联合类型统一处理
- `SearchModal.vue` 中统一显示和选择逻辑

### 2. **数据持久化模式**
- 使用 Vue 的 `watch` 监听数据变化
- 自动保存到 `localStorage`
- 应用启动时自动加载

### 3. **防抖搜索模式**
- `SearchModal.vue` 中使用 `watch` + `setTimeout` 实现 500ms 防抖
- 减少不必要的 API 调用

### 4. **本地索引模式（AniDB）**
- AniDB HTTP API 不支持搜索，使用本地 `anime-titles.dat` 文件
- 先本地搜索匹配 AID，再批量获取详情

### 5. **请求频率限制（AniDB）**
- AniDB API 有频率限制（每 2 秒一次）
- 使用 `waitForRequestInterval()` 函数控制请求间隔

---

## 🚀 关键功能点

### 1. 多 API 源支持
- **Bangumi**: 动画、书籍、音乐、游戏、三次元
- **VNDB**: 视觉小说
- **AniDB**: 动画（通过本地索引 + HTTP API）

### 2. NSFW 内容支持（Bangumi）
- 默认 Access Token（内置）
- 用户可自定义 Token（通过设置页面）
- Token 优先级：用户自定义 > 默认 Token

### 3. 图片处理
- 多尺寸图片支持（small, grid, medium, large）
- 图片 URL 优先级处理
- 占位图（SVG base64）用于缺失图片

### 4. 错误处理
- 自定义错误类（`BangumiError`, `AnidbError`）
- 超时处理（Bangumi 15 秒超时）
- 网络错误提示

---

## 📝 总结

这是一个基于 Vue 3 + TypeScript 的 Tier List 应用，核心特点是：

1. **模块化设计**：组件、工具函数、类型定义分离
2. **数据驱动**：使用 Vue 响应式系统 + localStorage 持久化
3. **多 API 集成**：统一接口处理不同 API 源
4. **用户体验**：防抖搜索、自动保存、错误提示

所有文件通过 `types.ts` 共享类型定义，通过 `storage.ts` 统一管理数据持久化，通过组件事件系统实现数据流传递。

